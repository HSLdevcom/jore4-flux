name: Test e2e cluster setup

on:
  push:
  pull_request:
    branches: [master]

jobs:
  local-e2e-setup:
    name: e2e setup locally
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Start Kind
        run: "./kindcluster.sh start --cluster=clusters/e2e"

      - name: Verify that application is up and running
        run: |
          for i in {1..20}; do
            curl --fail http://localhost:8000 --output /dev/null --silent && break
            sleep 5
            echo $i
          done

      - name: Stop Kind
        run: "./kindcluster.sh stop"

  remote-e2e-setup:
    name: e2e setup remotely
    runs-on: ubuntu-20.04

    steps:
      # note that we don't checkout code in this job to make sure that the workspace is empty!
      - name: Verifying that current workspace is empty
        run: '[ -z "$(ls -A)" ]'

      - name: Extract branch name to env variable
        run: |
          # In pull requests
          BRANCH_NAME="${GITHUB_HEAD_REF}"
          [[ ${BRANCH_NAME} == "" ]] && {
            # In branch pushes
            BRANCH_NAME="$(echo "${GITHUB_REF}" | cut -d '/' -f 3-)"
          }
          echo "BRANCH_NAME=${BRANCH_NAME}" >> "${GITHUB_ENV}"

      - name: Setup e2e cluster with the remote script
        run: "curl https://raw.githubusercontent.com/HSLdevcom/jore4-flux/${BRANCH_NAME}/remotecluster.sh | bash"

      - name: Verify that application is up and running
        run: |
          for i in {1..20}; do
            curl --fail http://localhost:8000 --output /dev/null --silent && break
            sleep 5
            echo $i
          done

      - name: Stop Kind
        run: "curl https://raw.githubusercontent.com/HSLdevcom/jore4-flux/${BRANCH_NAME}/kindcluster.sh | bash -s -- stop"
